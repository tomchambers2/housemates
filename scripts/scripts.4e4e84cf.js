"use strict";var loginRequired=["$location","$q","login",function(a,b,c){var d=b.defer();c.$getCurrentUser().then(function(b){return b?d.resolve():(d.reject(),a.path("/login")),d.promise})}],loginProhibited=["$location","$q","login",function(a,b,c){var d=b.defer();c.$getCurrentUser().then(function(b){return b?(d.reject(),a.path("/matches")):d.resolve(),d.promise})}];angular.module("roommatesApp",["ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch","google-maps","firebase","geocoder","reverseGeocoder","ngStorage"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl",resolve:{loginProhibited:loginProhibited}}).when("/choosetype",{templateUrl:"views/choosetype.html",controller:"ChoosetypeCtrl",resolve:{checkProgress:["$location","$localStorage",function(a,b){b.mainType&&a.path("/chooselocation")}],loginProhibited:loginProhibited}}).when("/chooselocation",{templateUrl:"views/chooselocation.html",controller:"ChooselocationCtrl",resolve:{checkProgress:["$location","$localStorage",function(a,b){b.mainType||a.path("/choosetype"),b.location&&a.path("/questions")}],loginProhibited:loginProhibited}}).when("/questions/",{templateUrl:"views/question.html",controller:"QuestionCtrl",resolve:{checkProgress:["$location","$localStorage",function(a,b){b.mainType&&b.location||a.path("/chooselocation")}],loginProhibited:loginProhibited}}).when("/createaccount",{templateUrl:"views/create.html",controller:"CreateCtrl",resolve:{checkProgress:["$location","$localStorage",function(a,b){b.mainType&&b.location&&b.answers||a.path("/questions")}],loginProhibited:loginProhibited}}).when("/register",{templateUrl:"views/register.html",controller:"RegisterCtrl",resolve:{loginRequired:loginRequired}}).when("/matches",{templateUrl:"views/matches.html",controller:"MatchesCtrl",resolve:{loginRequired:loginRequired}}).when("/admin",{templateUrl:"views/admin.html",controller:"AdminCtrl",resolve:{loginRequired:loginRequired}}).when("/login",{templateUrl:"views/login.html",controller:"LoginCtrl"}).otherwise({redirectTo:"/"})}]),angular.module("roommatesApp").controller("MainCtrl",["$scope","$location","$anchorScroll",function(a,b,c){a.scrollTo=function(a){b.hash(a),c()}}]),angular.module("roommatesApp").controller("AboutCtrl",["$scope",function(a){a.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"]}]),angular.module("roommatesApp").service("getStuff",function(){}),angular.module("roommatesApp").controller("ChooselocationCtrl",["$scope","$localStorage","$timeout","$location","Geocoder",function(a,b,c,d,e){a.findLocation=function(){a.location&&e.geocodeAddress(a.location).then(function(b){a.coords={lat:b.lat,lng:b.lng},a.map={center:{latitude:b.lat,longitude:b.lng},zoom:12},a.circle={id:1,center:{latitude:b.lat,longitude:b.lng},radius:500,stroke:{color:"#000",weight:2,opacity:1},fill:{color:"#000",opacity:.5},draggable:!0,editable:!0}},function(){a.$broadcast("error","Sorry, we couldn't find that address")})},a.submitLocation=function(){b.location={lat:a.circle.center.latitude,lng:a.circle.center.longitude,radius:a.circle.radius},d.path("/questions/")},a.resetSearch=function(){a.coords=null,a.location=""}}]),angular.module("roommatesApp").controller("QuestionCtrl",["$scope","$location","$localStorage","loadDatabase",function(a,b,c,d){a.selected={},c.currentQuestion=c.currentQuestion||0,c.answers=c.answers||{};var e=d("questions"),f=e.$asArray();f.$loaded().then(function(){a.proceed(!1)});var g=function(b){a.questionText=f[b].questionText,a.answers=f[b].answers};a.proceed=function(d){d&&c.currentQuestion++,c.currentQuestion<f.length?(a.selected={},g(c.currentQuestion)):b.path("/createaccount")},a.select=function(b){a.selected.any=!0;for(var d=0;d<a.answers.length;d++)a.selected[d]=!1;a.selected[b]=!0,c.answers[f[c.currentQuestion].$id]=b}}]),angular.module("roommatesApp").controller("CreateCtrl",["$scope","$localStorage","loadDatabase","login","$location","createMatches","reverseGeocoder",function(a,b,c,d,e,f,g){var h=c("users");a.facebookLogin=function(){d.$login("facebook",{rememberMe:!0,scope:"email"}).then(function(a){console.log(a);var c=a.thirdPartyUserData.email||"";h.$set(a.uid,{email:c,gender:a.thirdPartyUserData.gender,name:a.thirdPartyUserData.name,picture:a.thirdPartyUserData.picture.data.url,age_range:a.thirdPartyUserData.age_range,location:b.location,answers:b.answers,mainType:b.mainType,subType:b.subType,lastLooking:Date.now()}),g.geocodeLatlng(new google.maps.LatLng(b.location.lat,b.location.lng)).then(function(b){console.log(b.components,a.uid),h.$update(a.uid,{address_components:b.components})}),delete b.mainType,delete b.subType,delete b.answers,delete b.location,delete b.address_components,delete b.currentQuestion,f.forUser(a.uid),e.path("/register")})}}]),angular.module("roommatesApp").factory("simpleLogin",["$firebaseSimpleLogin",function(a){var b=new Firebase("https://housemates.firebaseio.com");return a(b)}]),angular.module("geocoder",["ngStorage"]).factory("Geocoder",["$localStorage","$q","$timeout","$rootScope",function(a,b,c,d){var e=a.locations?JSON.parse(a.locations):{},f=[],g=250,h=function(){var b=f[0],i=new google.maps.Geocoder;i.geocode({address:b.address},function(i,j){if(j===google.maps.GeocoderStatus.OK){var k={components:i[0].address_components,lat:i[0].geometry.location.lat(),lng:i[0].geometry.location.lng(),formattedAddress:i[0].formatted_address};e[b.address]=k,a.locations=JSON.stringify(e),f.shift(),b.d.resolve(k)}else j===google.maps.GeocoderStatus.ZERO_RESULTS?(f.shift(),b.d.reject({type:"zero",message:"Zero results for geocoding address "+b.address})):j===google.maps.GeocoderStatus.OVER_QUERY_LIMIT?b.executedAfterPause&&(f.shift(),b.d.reject({type:"busy",message:"Geocoding server is busy can not process address "+b.address})):j===google.maps.GeocoderStatus.REQUEST_DENIED?(f.shift(),b.d.reject({type:"denied",message:"Request denied for geocoding address "+b.address})):(f.shift(),b.d.reject({type:"invalid",message:"Invalid request for geocoding: status="+j+", address="+b.address}));if(f.length)if(j===google.maps.GeocoderStatus.OVER_QUERY_LIMIT){var l=f[0];l.executedAfterPause=!0,c(h,g)}else c(h,0);d.$$phase||d.$apply()})};return{geocodeAddress:function(a){var c=b.defer();return _.has(e,a)?c.resolve(e[a]):(f.push({address:a,d:c}),1===f.length&&h()),c.promise}}}]),angular.module("roommatesApp").controller("RegisterCtrl",["$scope","login","loadDatabase",function(a,b,c){a.loaded=!1,b.$getCurrentUser().then(function(b){var d=c("users/"+b.uid).$asObject();d.$loaded().then(function(){a.loaded=!0,d.email||(a.noemail=!0)}),d.$bindTo(a,"user")})}]),angular.module("roommatesApp").factory("login",["$firebaseSimpleLogin",function(a){var b=new Firebase("https://housemates.firebaseio.com/");return a(b)}]),angular.module("roommatesApp").filter("range",function(){return function(a,b){b=parseInt(b);for(var c=0;b>c;c++)a.push(c);return a}}),angular.module("roommatesApp").controller("AdminCtrl",["$scope","$firebase",function(a,b){var c=new Firebase("https://housemates.firebaseio.com/questions/"),d=b(c),e=function(){a.questions=d.$asObject()};a.removeQuestion=function(a){console.log(a),d.$remove(a)},a.addQuestion=function(){var c=new Firebase("https://housemates.firebaseio.com/questions/"),d=b(c),e={questionText:a.question.questionText,questionType:a.question.questionType,answers:a.question.answers};d.$push(e),a.message="Saved new question",a.question={}},e()}]),angular.module("roommatesApp").controller("MatchesCtrl",["$scope","$firebase","loadDatabase","login","email",function(a,b,c,d){d.$getCurrentUser().then(function(b){a.user=b;var d=c("users/"+b.uid+"/matches");a.matchList=[],a.users={},d.$asArray().$loaded().then(function(b){console.log(b);for(var d=0;d<b.length;d++){var e=c("matches/"+b[d].$id).$asObject();e.$loaded().then(function(b){a.matchList.push(b);var d=c("users/"+b.user2).$asObject();d.$loaded().then(function(c){a.users[b.user2]=c})})}})}),a.rejectMatch=function(){},a.favoriteMatch=function(){}}]),angular.module("roommatesApp").controller("ChoosetypeCtrl",["$scope","$location","$localStorage",function(a,b,c){a.type="",a.form={wantroom:!1,wantbuddy:!1},a.proceed=!1,a.nextStep=function(){b.path("/chooselocation")},a.setType=function(b){a.mainType=b,c.mainType=b,"hasroom"===b?a.proceed=!0:"househunter"!==b||a.form.wantbuddy||a.form.wantroom||(a.proceed=!1)},a.$watch("form",function(b){a.proceed=b.wantbuddy===!0||b.wantroom===!0?!0:!1,c.subType={wantbuddy:b.wantbuddy,wantroom:b.wantroom}},!0)}]),angular.module("roommatesApp").filter("objectByKeyValFilter",function(){return function(a,b,c){var d={};return angular.forEach(a,function(a,e){a[b]&&a[b]==c&&(d[e]=a)}),d}}),angular.module("roommatesApp").factory("createMatches",["$http",function(a){var b=function(b){a.get("http://housemates-server.herokuapp.com/creatematches/"+b)};return{forUser:b}}]),angular.module("roommatesApp").factory("email",["$http","$q",function(a,b){var c=function(c,d,e){var f=b.defer();return e?a.get("http://housemates-server.herokuapp.com/sendemail/"+c+"/"+from+"/"+d+"/"+e).then(function(){f.resolve({status:"sent"})},function(){f.reject({status:"senderror"})}):f.reject({status:"invalid"}),f.promise};return{sendEmail:c}}]),angular.module("roommatesApp").directive("flashMessage",["$timeout",function(a){return{template:'<span class="error hidden">{{message}}</span>',restrict:"E",scope:{message:"@"},link:function(b,c){b.$on("error",function(){c.removeClass("hidden"),b.message="Sorry, we couldn't find that address",a(function(){c.addClass("hidden")},2e3)})}}}]),angular.module("roommatesApp").factory("loadDatabase",["$firebase",function(a){return function(b){var c=new Firebase("https://housemates.firebaseio.com/"+b);return a(c)}}]),angular.module("roommatesApp").directive("emailMatch",["email",function(a){return{templateUrl:"views/emailmatch.html",restrict:"E",controller:["$scope","$element","$attrs",function(b,c,d){console.log(d),b.message={content:""},b.checkValidity=function(){return b.message.content.length>20?!1:!0};var e="\n\nTo respond to this person, just reply to this email. Doing so will reveal your email address to them. If there's anything bad about this email please forward it to support@housemates.com and we'll sort it out";b.emailMatch=function(){console.log("sending email to ",d.match),a.sendEmail("tom.chambers@gmail.com",from,"An email from a match",b.message.content+e).then(function(a){console.log(a.status),"sent"===a.status&&(b.status=3)},function(a){("invalid"===a.status||"senderror"===a.status)&&(b.status=4)}),b.status=2},b.openEmail=function(){b.status=1}}]}}]),angular.module("roommatesApp").controller("ContainerCtrl",["$scope","$rootScope","$location","login",function(a,b,c,d){d.$getCurrentUser().then(function(b){a.loggedIn=!!b,console.log(b),a.name=b.displayName}),b.$on("$firebaseSimpleLogin:login",function(){a.loggedIn=!0}),b.$on("$firebaseSimpleLogin:logout",function(){a.loggedIn=!1}),a.logout=function(){d.$logout(),c.path("/")}}]),angular.module("roommatesApp").controller("LoginCtrl",["$scope","$location","login",function(a,b,c){a.login=function(){c.$login("facebook",{rememberMe:!0}).then(function(){b.path("/matches")},function(){throw a.$broadcast("error","Sorry, we couldn't log you in right now. Try again later."),new Error("Could not log user in")})}}]),angular.module("reverseGeocoder",["ngStorage"]).factory("reverseGeocoder",["$localStorage","$q","$timeout","$rootScope",function(a,b,c,d){var e=a.locations?JSON.parse(a.locations):{},f=[],g=250,h=function(){var b=f[0],i=new google.maps.Geocoder;i.geocode({latLng:b.address},function(i,j){if(j===google.maps.GeocoderStatus.OK){var k={components:i[0].address_components,lat:i[0].geometry.location.lat(),lng:i[0].geometry.location.lng(),formattedAddress:i[0].formatted_address};e[b.address]=k,a.locations=JSON.stringify(e),f.shift(),b.d.resolve(k)}else j===google.maps.GeocoderStatus.ZERO_RESULTS?(f.shift(),b.d.reject({type:"zero",message:"Zero results for geocoding address "+b.address})):j===google.maps.GeocoderStatus.OVER_QUERY_LIMIT?b.executedAfterPause&&(f.shift(),b.d.reject({type:"busy",message:"Geocoding server is busy can not process address "+b.address})):j===google.maps.GeocoderStatus.REQUEST_DENIED?(f.shift(),b.d.reject({type:"denied",message:"Request denied for geocoding address "+b.address})):(f.shift(),b.d.reject({type:"invalid",message:"Invalid request for geocoding: status="+j+", address="+b.address}));if(f.length)if(j===google.maps.GeocoderStatus.OVER_QUERY_LIMIT){var l=f[0];l.executedAfterPause=!0,c(h,g)}else c(h,0);d.$$phase||d.$apply()})};return{geocodeLatlng:function(a){var c=b.defer();return _.has(e,a)?c.resolve(e[a]):(f.push({address:a,d:c}),1===f.length&&h()),c.promise}}}]);